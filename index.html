<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0b1020" />
  <title>ë¯¼ìš° 1945 ìŠ¤íƒ€ì¼ ìŠˆíŒ…</title>

  <link rel="manifest" href="manifest.json" />
  <style>
    html, body { margin:0; height:100%; background:#0b1020; overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; }
    #wrap { position: relative; width:100%; height:100%; }
    canvas { width:100%; height:100%; display:block; touch-action:none; }

    .hud {
      position:absolute; left:12px; top:12px;
      color:#fff; font-weight:900; font-size:14px;
      text-shadow: 0 2px 6px rgba(0,0,0,0.6);
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      max-width: calc(100% - 170px);
    }
    .hud span { opacity:0.95; padding:6px 10px; border-radius:12px; background: rgba(255,255,255,0.10); backdrop-filter: blur(6px); }
    .btns {
      position:absolute; right:12px; top:12px;
      display:flex; gap:8px;
    }
    button {
      appearance:none; border:0; border-radius:12px; padding:10px 12px;
      font-weight:900; background:rgba(255,255,255,0.12); color:#fff;
      backdrop-filter: blur(6px);
    }
    button:active { transform: translateY(1px); }

    .panel {
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      color:#fff; text-align:center;
      padding:14px 16px; border-radius:18px;
      background:rgba(0,0,0,0.42);
      width:min(440px, 90vw);
      line-height:1.35;
      box-shadow: 0 10px 28px rgba(0,0,0,0.35);
    }
    .panel b { font-size:18px; display:block; margin-bottom:10px; }
    .panel small { opacity:0.9; display:block; margin-top:10px; }

    .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
    .chip {
      padding:10px 12px; border-radius:14px;
      background: rgba(255,255,255,0.12);
      font-weight:900;
      user-select:none;
      border: 1px solid rgba(255,255,255,0.10);
    }
    .chip.active { background: rgba(125,182,255,0.22); border-color: rgba(125,182,255,0.35); }

    .toast {
      position:absolute; left:50%; bottom:18px;
      transform:translateX(-50%);
      color:#fff; font-weight:900;
      background: rgba(0,0,0,0.45);
      padding:10px 12px; border-radius:14px;
      opacity:0; pointer-events:none;
      transition: opacity 160ms ease;
    }
    .toast.show { opacity:1; }
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="c"></canvas>

    <div class="hud">
      <span id="score">ì ìˆ˜: 0</span>
      <span id="coin">ì½”ì¸: 0</span>
      <span id="best">ìµœê³ : 0</span>
      <span id="life">ëª©ìˆ¨: 10</span>
      <span id="level">ìŠ¤í…Œì´ì§€: 1</span>
    </div>

    <div class="btns">
      <button id="soundBtn">ì‚¬ìš´ë“œ ON</button>
      <button id="pauseBtn">ì¼ì‹œì •ì§€</button>
      <button id="restartBtn">ì¬ì‹œì‘</button>
    </div>

    <div id="panel" class="panel">
      <b>ë¯¼ìš° 1945 ìŠ¤íƒ€ì¼ ìŠˆíŒ… âœˆï¸</b>
      <div>í™”ë©´ì„ <b>í„°ì¹˜í•´ì„œ ë“œë˜ê·¸</b>í•˜ë©´ ë¹„í–‰ê¸°ê°€ ì›€ì§ì—¬ìš”.</div>
      <div>ğŸ”« ë¹„í–‰ê¸°ëŠ” <b>ìë™ìœ¼ë¡œ ë¯¸ì‚¬ì¼ì„ ë°œì‚¬</b>í•´ìš”!</div>
      <div>ğŸª¨ ìš´ì„(ì )ì„ ë¶€ìˆ˜ê³  ğŸª™ ì½”ì¸ì„ ë¨¹ìœ¼ì„¸ìš”.</div>
      <div style="margin-top:10px; font-weight:900;">ë¹„í–‰ê¸° ìŠ¤í‚¨ ì„ íƒ</div>
      <div class="row" id="skinRow">
        <div class="chip active" data-skin="red">ë ˆë“œ</div>
        <div class="chip" data-skin="blue">ë¸”ë£¨</div>
        <div class="chip" data-skin="robot">ë¡œë´‡</div>
      </div>
      <small>(ì•„ë¬´ ê³³ì´ë‚˜ í„°ì¹˜í•˜ë©´ ì‹œì‘)</small>
    </div>

    <div id="toast" class="toast">+ì½”ì¸!</div>
  </div>

<script>
(() => {
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }

  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  const elScore = document.getElementById('score');
  const elCoin = document.getElementById('coin');
  const elBest = document.getElementById('best');
  const elLife = document.getElementById('life');
  const elLevel = document.getElementById('level');

  const panel = document.getElementById('panel');
  const toast = document.getElementById('toast');

  const pauseBtn = document.getElementById('pauseBtn');
  const restartBtn = document.getElementById('restartBtn');
  const soundBtn = document.getElementById('soundBtn');
  const skinRow = document.getElementById('skinRow');

  let W=0, H=0, DPR=1;

  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rand=(a,b)=>a+Math.random()*(b-a);
  const now=()=>performance.now();

  function resize(){
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    W = Math.floor(window.innerWidth);
    H = Math.floor(window.innerHeight);
    canvas.width = Math.floor(W * DPR);
    canvas.height = Math.floor(H * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener('resize', resize);
  resize();

  // ---------- ì‚¬ìš´ë“œ(WebAudio) ----------
  let audioEnabled = true;
  soundBtn.textContent = 'ì‚¬ìš´ë“œ ON';

  function beep(freq=440, dur=0.06, type='sine', gain=0.06) {
    if (!audioEnabled) return;
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) return;
    const ac = beep._ac || (beep._ac = new AudioCtx());
    if (ac.state === 'suspended') ac.resume().catch(()=>{});
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(ac.destination);
    const t = ac.currentTime;
    g.gain.setValueAtTime(gain, t);
    g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
    o.start(t); o.stop(t + dur);
  }
  const sfx = {
    start(){ beep(660,0.06,'triangle',0.06); beep(880,0.06,'triangle',0.05); },
    shoot(){ beep(720,0.03,'square',0.045); },
    hit(){ beep(140,0.10,'sawtooth',0.085); },
    boom(){ beep(220,0.06,'square',0.07); beep(110,0.10,'sawtooth',0.06); },
    coin(){ beep(880,0.05,'triangle',0.07); beep(1320,0.05,'triangle',0.05); },
    boss(){ beep(240,0.10,'square',0.08); beep(180,0.12,'square',0.06); }
  };

  soundBtn.addEventListener('click', () => {
    audioEnabled = !audioEnabled;
    soundBtn.textContent = audioEnabled ? 'ì‚¬ìš´ë“œ ON' : 'ì‚¬ìš´ë“œ OFF';
    beep(440,0.04,'sine',0.04);
  });

  // ---------- UI ----------
  function showToast(text){
    toast.textContent = text;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove('show'), 450);
  }

  // ---------- ê²Œì„ ìƒíƒœ ----------
  const state = {
    running:false, paused:false, gameOver:false,
    t:0, lastTs:0,

    score:0, coin:0,
    best:Number(localStorage.getItem('minwoo_plane_best')||0),

    stage:1,
    lives:10,            // âœ… ëª©ìˆ¨ 10ê°œ
    invuln:0,            // í”¼ê²© ë¬´ì 

    // 1945 ëŠë‚Œ: ê³„ì† ë‚´ë ¤ì˜¤ëŠ” ë°°ê²½ + ìë™ì‚¬ê²©
    bgScroll:0,

    // ìŠ¤í°/ë‚œì´ë„
    enemySpeed:240,
    enemySpawnEvery:0.65,
    enemySpawnTimer:0,

    coinEvery:1.6,
    coinTimer:0,

    bossEvery:12.0,
    bossTimer:0,

    // ìë™ë°œì‚¬(ê¸°ê´€ì´ ëŠë‚Œ)
    fireEvery:0.12,     // ë°œì‚¬ ê°„ê²©(ì‘ì„ìˆ˜ë¡ ë” ë¹ ë¦„)
    fireTimer:0,

    skin: localStorage.getItem('minwoo_plane_skin') || 'robot',
  };

  // ---------- ê°ì²´ ----------
  const player = { x: W*0.5, y: H*0.80, r:18, targetX:null, targetY:null };

  // ì (ìš´ì„=ì ê¸° ì—­í• ) + ë³´ìŠ¤(í° ìš´ì„, ì²´ë ¥ ìˆìŒ)
  // enemy: {x,y,r,vy,hp,isBoss}
  const enemies = [];

  // ë¯¸ì‚¬ì¼: {x,y,vy,r}
  const missiles = [];

  // ì½”ì¸: {x,y,vy,r,spin}
  const coins = [];

  // í­ë°œ íŒŒí‹°í´: {x,y,vx,vy,life}
  const sparks = [];

  function updateHud(){
    elScore.textContent = `ì ìˆ˜: ${Math.floor(state.score)}`;
    elCoin.textContent  = `ì½”ì¸: ${state.coin}`;
    elBest.textContent  = `ìµœê³ : ${state.best}`;
    elLife.textContent  = `ëª©ìˆ¨: ${state.lives}`;
    elLevel.textContent = `ìŠ¤í…Œì´ì§€: ${state.stage}`;
  }
  updateHud();
  elBest.textContent = `ìµœê³ : ${state.best}`;

  // ---------- ìŠ¤í‚¨ ----------
  function applySkinUI(){
    [...skinRow.querySelectorAll('.chip')].forEach(ch=>{
      ch.classList.toggle('active', ch.dataset.skin === state.skin);
    });
  }
  applySkinUI();

  skinRow.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip');
    if(!chip) return;
    state.skin = chip.dataset.skin;
    localStorage.setItem('minwoo_plane_skin', state.skin);
    applySkinUI();
    beep(520,0.04,'triangle',0.05);
  });

  function skinColors(){
    if (state.skin === 'blue') return { body:'#cfe7ff', wing:'#3e7bff', accent:'#7db6ff' };
    if (state.skin === 'robot') return { body:'#e9e9ef', wing:'#ff6b6b', accent:'#9be3ff' };
    return { body:'#ffe5e5', wing:'#ff3b3b', accent:'#7db6ff' };
  }

  // ---------- ì¡°ì‘(ë“œë˜ê·¸) ----------
  let isPointerDown = false;
  function pointerPos(e){
    const rect = canvas.getBoundingClientRect();
    return { x: (e.clientX - rect.left), y: (e.clientY - rect.top) };
  }

  canvas.addEventListener('pointerdown', (e)=>{
    canvas.setPointerCapture(e.pointerId);
    isPointerDown = true;
    const p = pointerPos(e);

    if(!state.running && !state.gameOver){
      state.running = true; panel.style.display='none'; sfx.start();
    } else if(state.gameOver){
      resetGame();
      state.running = true; panel.style.display='none'; sfx.start();
    }

    player.targetX = p.x; player.targetY = p.y;
  });

  canvas.addEventListener('pointermove', (e)=>{
    if(!isPointerDown) return;
    const p = pointerPos(e);
    player.targetX = p.x; player.targetY = p.y;
  });

  canvas.addEventListener('pointerup', ()=>{
    isPointerDown = false;
    player.targetX = null; player.targetY = null;
  });

  pauseBtn.addEventListener('click', ()=>{
    if(!state.running && !state.gameOver) return;
    state.paused = !state.paused;
    pauseBtn.textContent = state.paused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€';
    beep(300,0.04,'sine',0.04);
  });

  restartBtn.addEventListener('click', ()=>{
    resetGame();
    state.running = true;
    panel.style.display='none';
    sfx.start();
  });

  // ---------- ìŠ¤í°/ì´í™íŠ¸ ----------
  function spawnEnemy(isBoss=false){
    const r = isBoss ? rand(44,62) : rand(14,26);
    const x = rand(r+12, W-r-12);
    const y = -r - 16;
    const vy = state.enemySpeed * (isBoss ? 0.85 : 1.0) * rand(0.95, 1.20);
    const hp = isBoss ? 12 : 1; // âœ… ë³´ìŠ¤ëŠ” ì—¬ëŸ¬ ë°œ ë§ì•„ì•¼ íŒŒê´´(1945 ê°ì„±)
    enemies.push({x,y,r,vy,hp,isBoss});
  }

  function spawnCoin(){
    const r = rand(10,14);
    const x = rand(r+18, W-r-18);
    const y = -r - 12;
    const vy = state.enemySpeed * 0.75 * rand(0.90, 1.10);
    coins.push({x,y,r,vy,spin:rand(0,Math.PI*2)});
  }

  function shoot(){
    // 1945 ëŠë‚Œ: 2ë°œ ê¸°ê´€ì´
    const vy = 980; // ë¯¸ì‚¬ì¼ ì†ë„
    const r = 3.2;
    missiles.push({x: player.x - 7, y: player.y - player.r - 6, vy, r});
    missiles.push({x: player.x + 7, y: player.y - player.r - 6, vy, r});
    sfx.shoot();
  }

  function boom(x,y,amount=18){
    for(let i=0;i<amount;i++){
      const a = rand(0, Math.PI*2);
      const sp = rand(80, 360);
      sparks.push({x,y, vx: Math.cos(a)*sp, vy: Math.sin(a)*sp, life: rand(0.18, 0.45)});
    }
    sfx.boom();
    if (navigator.vibrate) navigator.vibrate(20);
  }

  function circleHit(ax,ay,ar,bx,by,br){
    const dx=ax-bx, dy=ay-by;
    const rr=ar+br;
    return (dx*dx+dy*dy) <= rr*rr;
  }

  function onPlayerHit(){
    if(state.invuln>0) return;
    state.lives -= 1;
    state.invuln = 1.0;
    updateHud();

    sfx.hit();
    if (navigator.vibrate) navigator.vibrate(90);

    if(state.lives<=0){
      setGameOver();
    } else {
      showToast(`-1 ëª©ìˆ¨! (ë‚¨ì€ ëª©ìˆ¨ ${state.lives})`);
    }
  }

  function onCoin(){
    state.coin += 1;
    state.score += 40 + state.stage * 3;
    updateHud();
    sfx.coin();
    if (navigator.vibrate) navigator.vibrate(15);
    showToast('+ì½”ì¸! ì ìˆ˜ ë³´ë„ˆìŠ¤');
  }

  // ---------- ë¦¬ì…‹/ê²Œì„ì˜¤ë²„ ----------
  function resetGame(){
    state.running=false; state.paused=false; state.gameOver=false;
    state.t=0; state.bgScroll=0; state.score=0; state.coin=0;

    state.stage=1;
    state.lives=10;
    state.invuln=0;

    state.enemySpeed=240;
    state.enemySpawnEvery=0.65;
    state.enemySpawnTimer=0;

    state.coinEvery=1.6;
    state.coinTimer=0;

    state.bossEvery=12.0;
    state.bossTimer=0;

    state.fireEvery=0.12;
    state.fireTimer=0;

    enemies.length=0; missiles.length=0; coins.length=0; sparks.length=0;

    player.x=W*0.5; player.y=H*0.80;
    player.targetX=null; player.targetY=null;

    panel.style.display='block';
    panel.innerHTML = document.getElementById('panel').innerHTML; // ìœ ì§€
    pauseBtn.textContent='ì¼ì‹œì •ì§€';
    updateHud();
    applySkinUI();
  }

  function setGameOver(){
    state.gameOver=true;
    state.running=false;
    state.paused=false;

    state.best = Math.max(state.best, Math.floor(state.score));
    localStorage.setItem('minwoo_plane_best', String(state.best));
    updateHud();

    panel.style.display='block';
    panel.innerHTML = `
      <b>ê²Œì„ ì˜¤ë²„ ğŸ˜µ</b>
      <div>ì ìˆ˜: <b>${Math.floor(state.score)}</b></div>
      <div>ì½”ì¸: <b>${state.coin}</b> / ìµœê³ : <b>${state.best}</b></div>
      <div style="margin-top:10px; font-weight:900;">í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ë‹¤ì‹œ ì‹œì‘!</div>
      <small>(ì•„ë¹ ê°€ ë§Œë“  1945 ìŠˆíŒ… ğŸ™‚)</small>
    `;
  }

  // ---------- ë Œë”: 1945 ëŠë‚Œ(ì„¸ë¡œ ìŠ¤í¬ë¡¤) ----------
  function drawBackground(dt){
    // ìŠ¤í¬ë¡¤ ì†ë„
    const scrollSpeed = 110 + state.stage * 8;
    state.bgScroll = (state.bgScroll + scrollSpeed * dt) % H;

    // ë°¤í•˜ëŠ˜ ê·¸ë¼ë°ì´ì…˜
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, '#08102a');
    g.addColorStop(1, '#060a18');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // ë³„(ë°˜ë³µ íŒ¨í„´)
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = '#ffffff';
    for(let i=0;i<70;i++){
      const x = (i*97) % W;
      const y = ((i*163) + state.bgScroll) % H;
      ctx.fillRect(x, y, 2, 2);
    }
    ctx.globalAlpha = 1;

    // â€œêµ¬ë¦„/ë¹› ì¤„â€ ê°™ì€ ìŠ¤í¬ë¡¤ ë ˆì´ì–´ (ê³ ì „ ìŠˆíŒ… ëŠë‚Œ)
    ctx.globalAlpha = 0.08;
    ctx.fillStyle = '#7db6ff';
    for(let i=0;i<6;i++){
      const y = ((i*220) + state.bgScroll*1.2) % (H+220) - 220;
      ctx.fillRect(0, y, W, 60);
    }
    ctx.globalAlpha = 1;
  }

  function drawPlayer(){
    const c = skinColors();
    if(state.invuln>0 && Math.floor(state.t*14)%2===0) ctx.globalAlpha = 0.35;

    ctx.save();
    ctx.translate(player.x, player.y);

    // ë³¸ì²´
    ctx.fillStyle = c.body;
    ctx.beginPath();
    ctx.moveTo(0, -player.r - 8);
    ctx.lineTo(player.r, player.r + 10);
    ctx.lineTo(0, player.r - 2);
    ctx.lineTo(-player.r, player.r + 10);
    ctx.closePath();
    ctx.fill();

    // ë‚ ê°œ
    ctx.fillStyle = c.wing;
    ctx.beginPath();
    ctx.moveTo(-player.r, 2);
    ctx.lineTo(-player.r-14, player.r-2);
    ctx.lineTo(-8, player.r+6);
    ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(player.r, 2);
    ctx.lineTo(player.r+14, player.r-2);
    ctx.lineTo(8, player.r+6);
    ctx.closePath();
    ctx.fill();

    // ì½•í•
    ctx.fillStyle = c.accent;
    ctx.beginPath();
    ctx.ellipse(0, -6, 6, 10, 0, 0, Math.PI*2);
    ctx.fill();

    // ì—”ì§„ ë¶ˆê½ƒ
    if(state.running && !state.paused && !state.gameOver){
      ctx.globalAlpha = 0.85;
      ctx.fillStyle = '#ffcc66';
      ctx.beginPath();
      ctx.moveTo(0, player.r + 10);
      ctx.lineTo(7, player.r + 20 + Math.sin(state.t*16)*3);
      ctx.lineTo(-7, player.r + 20 + Math.sin(state.t*16)*3);
      ctx.closePath();
      ctx.fill();
      ctx.globalAlpha = 1;
    }

    ctx.restore();
    ctx.globalAlpha = 1;
  }

  function drawMissiles(){
    ctx.fillStyle = '#e9f1ff';
    for(const m of missiles){
      ctx.beginPath();
      ctx.roundRect(m.x - 2.2, m.y - 10, 4.4, 12, 3);
      ctx.fill();

      // ê¼¬ë¦¬
      ctx.globalAlpha = 0.45;
      ctx.fillStyle = '#7db6ff';
      ctx.fillRect(m.x - 1.2, m.y + 2, 2.4, 10);
      ctx.globalAlpha = 1;
      ctx.fillStyle = '#e9f1ff';
    }
  }

  function drawEnemies(){
    for(const e of enemies){
      const boss = e.isBoss;

      // ëª¸ì²´
      ctx.fillStyle = boss ? '#ff9a57' : '#ff6b6b';
      ctx.beginPath();
      ctx.arc(e.x, e.y, e.r, 0, Math.PI*2);
      ctx.fill();

      // ê·¸ë¦¼ì
      ctx.globalAlpha = 0.22;
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.arc(e.x + e.r*0.25, e.y + e.r*0.25, e.r*0.65, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;

      // ë³´ìŠ¤ ì²´ë ¥ë°”(ê°„ë‹¨)
      if(boss){
        const w = 80, h = 8;
        const hpMax = 12;
        const ratio = clamp(e.hp / hpMax, 0, 1);
        ctx.globalAlpha = 0.9;
        ctx.fillStyle = 'rgba(255,255,255,0.18)';
        ctx.fillRect(e.x - w/2, e.y - e.r - 18, w, h);
        ctx.fillStyle = '#7db6ff';
        ctx.fillRect(e.x - w/2, e.y - e.r - 18, w*ratio, h);
        ctx.globalAlpha = 1;
      }
    }
  }

  function drawCoins(){
    for(const c of coins){
      const w = c.r * (0.65 + 0.35*Math.abs(Math.sin(c.spin)));
      ctx.fillStyle = '#ffd54a';
      ctx.beginPath();
      ctx.ellipse(c.x, c.y, w, c.r, 0, 0, Math.PI*2);
      ctx.fill();

      ctx.globalAlpha = 0.25;
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.ellipse(c.x + 2, c.y + 2, w*0.7, c.r*0.7, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  function drawSparks(){
    ctx.globalAlpha = 0.9;
    ctx.fillStyle = '#ffcc66';
    for(const p of sparks){
      ctx.fillRect(p.x, p.y, 3, 3);
    }
    ctx.globalAlpha = 1;
  }

  // ---------- ì—…ë°ì´íŠ¸ ----------
  function update(dt){
    state.t += dt;

    // ë¬´ì  ê°ì†Œ
    if(state.invuln>0) state.invuln = Math.max(0, state.invuln - dt);

    // ìŠ¤í…Œì´ì§€(ë‚œì´ë„) ìƒìŠ¹: ì ìˆ˜ ê¸°ë°˜
    const newStage = Math.min(30, 1 + Math.floor(state.score / 250));
    if(newStage !== state.stage){
      state.stage = newStage;

      // ë‚œì´ë„: ì  ë¹¨ë¼ì§ + ë” ìì£¼ ë“±ì¥ + ë°œì‚¬ ì•½ê°„ ë¹¨ë¼ì§(ê¸°ë¶„ ì¢‹ê²Œ)
      state.enemySpeed = 240 + (state.stage-1)*14;
      state.enemySpawnEvery = Math.max(0.30, 0.65 - (state.stage-1)*0.018);
      state.coinEvery = Math.max(0.85, 1.60 - (state.stage-1)*0.02);
      state.fireEvery = Math.max(0.08, 0.12 - (state.stage-1)*0.001); // ë„ˆë¬´ ê³¼í•˜ì§€ ì•Šê²Œ
      updateHud();
    }

    // í”Œë ˆì´ì–´ ì´ë™(ì†ê°€ë½ ë”°ë¼ê°€ê¸°)
    const follow = 14;
    if(player.targetX !== null){
      player.x += (player.targetX - player.x) * clamp(follow*dt, 0, 1);
      player.y += (player.targetY - player.y) * clamp(follow*dt, 0, 1);
    }
    player.x = clamp(player.x, player.r+10, W-player.r-10);
    player.y = clamp(player.y, player.r+10, H-player.r-10);

    // ìë™ ë°œì‚¬
    state.fireTimer += dt;
    while(state.fireTimer >= state.fireEvery){
      state.fireTimer -= state.fireEvery;
      shoot();
    }

    // ì  ìƒì„±
    state.enemySpawnTimer += dt;
    while(state.enemySpawnTimer >= state.enemySpawnEvery){
      state.enemySpawnTimer -= state.enemySpawnEvery;
      spawnEnemy(false);
    }

    // ì½”ì¸ ìƒì„±
    state.coinTimer += dt;
    while(state.coinTimer >= state.coinEvery){
      state.coinTimer -= state.coinEvery;
      spawnCoin();
    }

    // ë³´ìŠ¤ ìƒì„±
    state.bossTimer += dt;
    if(state.bossTimer >= state.bossEvery){
      state.bossTimer = 0;
      spawnEnemy(true);
      sfx.boss();
      showToast('ë³´ìŠ¤ ë“±ì¥!');
      if(navigator.vibrate) navigator.vibrate([40,40,40]);
    }

    // ë¯¸ì‚¬ì¼ ì´ë™
    for(let i=missiles.length-1;i>=0;i--){
      const m = missiles[i];
      m.y -= m.vy * dt;
      if(m.y < -40) missiles.splice(i,1);
    }

    // ì  ì´ë™ + í”Œë ˆì´ì–´ ì¶©ëŒ
    for(let i=enemies.length-1;i>=0;i--){
      const e = enemies[i];
      e.y += e.vy * dt;

      if(circleHit(player.x, player.y, player.r*0.9, e.x, e.y, e.r*0.95)){
        onPlayerHit();
      }

      // í™”ë©´ ì•„ë˜ë¡œ ì§€ë‚˜ê°€ë©´ íŒ¨ë„í‹° ì—†ì´ ì œê±°(1945 ëŠë‚Œ: ì§€ë‚˜ê°€ë©´ ê·¸ëƒ¥ ì†í•´)
      if(e.y - e.r > H + 40){
        enemies.splice(i,1);
      }
    }

    // ë¯¸ì‚¬ì¼ vs ì  ì¶©ëŒ
    for(let ei=enemies.length-1; ei>=0; ei--){
      const e = enemies[ei];
      let hitCount = 0;

      for(let mi=missiles.length-1; mi>=0; mi--){
        const m = missiles[mi];
        if(circleHit(m.x, m.y, m.r+2, e.x, e.y, e.r*0.92)){
          missiles.splice(mi,1);
          e.hp -= 1;
          hitCount++;
          // ë§ì„ ë•Œ ì‘ì€ ìŠ¤íŒŒí¬
          boom(m.x, m.y, 6);
          break; // í•œ ë¯¸ì‚¬ì¼ì€ í•œ ë²ˆë§Œ
        }
      }

      if(hitCount>0){
        // ë³´ìŠ¤ëŠ” ê³„ì† ë‚¨ê³ , ì¼ë°˜ì€ 1ë°©ì— í„°ì§
        if(e.hp <= 0){
          const bonus = e.isBoss ? 180 : 35;
          state.score += bonus;
          if(e.isBoss) showToast('ë³´ìŠ¤ ê²©íŒŒ!');
          boom(e.x, e.y, e.isBoss ? 30 : 18);
          enemies.splice(ei,1);
        }
      }
    }

    // ì½”ì¸ ì´ë™ + íšë“
    for(let i=coins.length-1;i>=0;i--){
      const c = coins[i];
      c.y += c.vy * dt;
      c.spin += dt * 8.0;

      if(circleHit(player.x, player.y, player.r*0.95, c.x, c.y, c.r*0.9)){
        coins.splice(i,1);
        onCoin();
        continue;
      }
      if(c.y - c.r > H + 30) coins.splice(i,1);
    }

    // ìŠ¤íŒŒí¬ ì—…ë°ì´íŠ¸
    for(let i=sparks.length-1;i>=0;i--){
      const p = sparks[i];
      p.life -= dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.vx *= 0.92;
      p.vy *= 0.92;
      if(p.life <= 0) sparks.splice(i,1);
    }

    // ì ìˆ˜: ìƒì¡´ + ì§„í–‰
    state.score += dt * (6 + state.stage*0.25);
    updateHud();
  }

  // ---------- ë£¨í”„ ----------
  function loop(ts){
    requestAnimationFrame(loop);
    if(!state.lastTs) state.lastTs = ts;
    const dt = Math.min(0.033, (ts - state.lastTs)/1000);
    state.lastTs = ts;

    drawBackground(dt);

    if(state.running && !state.paused && !state.gameOver){
      update(dt);
    }

    drawCoins();
    drawEnemies();
    drawMissiles();
    drawSparks();
    drawPlayer();

    if(state.paused && !state.gameOver){
      ctx.fillStyle='rgba(0,0,0,0.35)';
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#fff';
      ctx.font='900 28px system-ui';
      ctx.textAlign='center';
      ctx.fillText('ì¼ì‹œì •ì§€', W/2, H/2);
      ctx.font='700 14px system-ui';
      ctx.fillText('ì˜¤ë¥¸ìª½ ìœ„ "ì¬ê°œ"ë¥¼ ëˆ„ë¥´ì„¸ìš”', W/2, H/2 + 28);
    }
  }

  // ì‹œì‘
  resetGame();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
